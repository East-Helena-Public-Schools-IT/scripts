#!/bin/bash

# Make sure the packages are installed (even with the -y flag it may still require user input, because apt is dumb like that)
echo "Installing dependencies..."
# Needed for minimal vnc installation
apt install xvfb x11vnc dbus-x11 -y
# Not technically needed, but are nice
apt install xfce4 -y
apt install firefox -y

# Set VNC password
printf "\n\nWhat should the VNC password be?\n"
read -r PASSWD
x11vnc -storepasswd $PASSWD /usr/local/vnc.passwd
# make sure the vncuser can access it
chmod a=r /usr/local/vnc.passwd

# Setup service
service="/etc/systemd/system/vnc.service"
curl https://raw.githubusercontent.com/East-Helena-Public-Schools-IT/scripts/main/linux/vnc/vnc.service > $service
chmod 664 $service

# Download vnc script
script="/usr/local/bin/headless-vnc"
curl https://raw.githubusercontent.com/East-Helena-Public-Schools-IT/scripts/main/linux/vnc/headless-vnc > $script
chmod +x $script

# Create user. If you chagne from vncuser you must also change it in the service file
vncuser="vncuser"
useradd --create-home $vncuser -G sudo,video,tty --user-group --shell /bin/bash
passwd $vncuser 

# Allow user to startx
echo "allowed_users = anybody" > /etc/X11/Xwrapper.config
echo "needs_root_rights=yes" >> /etc/X11/Xwrapper.config

# Create .xinit file
su --login $vncuser -c 'cp /etc/X11/xinit/xinitrc ~/.xinitrc'

# Give user more perms
mkdir -p /etc/polkit-1/localauthority/50-local.d/
# BTW thank you u/cubic_thought
printf "
[Allow Colord all Users]
Identity=unix-user:*
Action=org.freedesktop.color-manager.create-device;org.freedesktop.color-manager.create-profile;org.freedesktop.color-manager.delete-device;org.freedesktop.color-manager.delete-profile;org.freedesktop.color-manager.modify-device;org.freedesktop.color-manager.modify-profile
ResultAny=no
ResultInactive=no
ResultActive=yes
" > /etc/polkit-1/localauthority/50-local.d/45-allow-colord.pkla

# Eanble service
systemctl daemon-reload
systemctl enable vnc

ufw allow 5900
